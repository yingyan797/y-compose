<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Y-Compose LTL</title>
    <link rel="icon" type="image/x-icon" href="static/logo.png"><style>
        th, td {
            border: solid skyblue;
        }
        .column {
            float: left;
            width: 50%;
        }
        .latent{
            display: none;
            border-radius: 5px;
        }.latent:hover {
            background-color: lightgreen;
            cursor: pointer;
        }
        .remove:hover {
            background-color: salmon;
            cursor: pointer;
        }
        #diagram {
            width: 97%;
            border: 1px dashed;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-graphviz/5.0.2/d3-graphviz.min.js"></script>
</head>
<body style="background-color: lightcyan;">
    <h2>Draw LTL to DFA | <a href="/ltl">reset</a> | <a href="/">Home</a></h2>
    <table style="margin: 10px; border-bottom: dashed; background-color: azure;">
        <tr><th class="annote" id="cfml" rowspan="2">Formula</th><td rowspan="2">
            <textarea id="ifml" rows="4" style="width: 95%;"></textarea><br></td>
            <th>Initial state</th><td id="initial">...</td>
            <td id="msgbox" rowspan="3" style="width: 100px;"></td></tr>
        <tr><th>Accepting states</th><td id="accepting">...</td></tr>
        <tr><th>File</th><td>
            <input type="file" id="ipf" oninput="load_file()">
            <input type="text" id="fname" value="example" minlength="1"> 
            <input type="checkbox" id="draw-dfa">Draw diagram
            <button id="load">Load DFA</button><button id="create">Create DFA</button>
            <button id="delete" class="remove">Delete</button></td>
            <th>Rejecting states</th><td id="rejecting">...</td></tr>
    </table>
    <i>Transition table for Formula: </i><b id="p_formula" style="font-size: large; color: blueviolet;"></b> 
    <button class="latent" id="write">Write back</button><button class="latent" id="copy">Copy</button>
    <table id="resultTable" style="padding-top: 5px; display: none;">
        <tr><td rowspan="2"><table id="transition"></table>
            <button class="latent" id="clear-color">Clear color annotation</button></td>
        <td><table id="matrix"></table></td></tr>
        <tr><td><div id="diagram" style="display: none;"></div><button class="latent" id="resetZoom">Reset zooming</button></td>
    </tr></table><iframe id="ltlf2dfa" src="http://ltlf2dfa.diag.uniroma1.it/" width="97%" height="500px"></iframe>

    <script>
        function load_file() {
            const fpath = document.getElementById("ipf").value;
            const fname = fpath.split("\\")[2].split(".")[0];
            document.getElementById("fname").value = fname;
        }
        document.addEventListener('DOMContentLoaded', function() {
            const loadButton = document.getElementById('load');
            const submitButton = document.getElementById('create');
            const delButton = document.getElementById('delete');
            const writeButton = document.getElementById('write');
            const copyButton = document.getElementById('copy');
            const formulaBox = document.getElementById('ifml');
            const formulaClear = document.getElementById('cfml');
            const p_formula = document.getElementById("p_formula");
            const clearColorButton = document.getElementById("clear-color");
            const drawDiagram = document.getElementById("draw-dfa");
            const diagram = document.getElementById("diagram");
            const msgbox = document.getElementById("msgbox");

            function create_table(data) {
                let trans_html = "";
                document.getElementById("p_formula").innerHTML = data.formula;
                document.getElementById("initial").innerHTML = data.initial_state;
                document.getElementById("accepting").innerHTML = data.accepting_states;
                document.getElementById("rejecting").innerHTML = data.rejecting_states;
                trans_html += "<tr><th id='state_f'>State from</th><th id='state_t'>State to</th>";
                for (let fv of data.free_variables) {
                    trans_html += "<td>"+fv+"</td>";
                }
                trans_html += "</tr>";
                for (let i=0; i < data.transitions.length; i++) {
                    const entry = data.transitions[i];
                    trans_html += "<tr><td id='pair_f_"+entry[0]+"' class='annote'>"+entry[0]+
                        "</td><td id='pair_t_"+entry[2]+"' class='annote'>"+entry[2]+"</td>";
                    for (let c of entry[1]) {
                        trans_html += "<td style='background-color:";
                        if (c == 0) {
                            trans_html += "lightsalmon";
                        } else if (c == 1) {
                            trans_html += "lightgreen";
                        } else {
                            trans_html += "skyblue";
                        }
                        trans_html += "'>"+c+"</td>";
                    }
                    trans_html += "</tr>";
                }
                document.getElementById('transition').innerHTML = trans_html;
                let matrix_html = "<tr><th>State</th>"
                for (let i=1; i <= data.matrix.length; i++) {
                    matrix_html += "<th id='pair_t_"+i+"' class='annote'>"+i+"</th>";
                }
                matrix_html += "</tr>"
                data.matrix.forEach((row, i) => {
                    matrix_html += "<tr><th id='pair_f_"+(i+1)+"' class='annote'>"+(i+1)+"</th>";
                    for (label of row) {
                        matrix_html += "<td style='background-color: azure'>"+label+"</td>";
                    }
                    matrix_html += "</tr>";
                })   
                document.getElementById("matrix").innerHTML = matrix_html;

                for (let c of ['f', 't']) {
                    const states = document.querySelectorAll("[id^='pair_"+c+"_']");
                    states.forEach((state, num) => {
                        state.addEventListener('click', function() {
                            const label = state.innerHTML;
                            const matching = document.querySelectorAll("[id='pair_"+c+"_"+label+"']");
                            matching.forEach((entry, i) => {
                                if (entry.style.backgroundColor != 'lightgoldenrodyellow') {
                                    entry.style.backgroundColor = 'lightgoldenrodyellow';
                                } else {
                                    entry.style.backgroundColor = 'lightcyan';
                                }
                            })
                        })
                    });
                }
                if (drawDiagram.checked) {
                    renderDFA(data["diagram_code"]);
                    diagram.style.display = "block";
                } else {
                    diagram.style.display = "none";
                }

                clearColorButton.addEventListener('click', function() {
                    document.querySelectorAll("[id^='pair_']").forEach((elem, i) => {
                        elem.style.backgroundColor = 'lightcyan';
                    });
                })
                clearColorButton.style.display = "block";
                writeButton.style.display = "inline";
                copyButton.style.display = "inline";
                msgbox.innerHTML = "Table created for formula "+data.formula.substring(0, 30);
                document.getElementById("resultTable").style.display = "block";
            }

            function renderDFA(dicode) {
                // Initialize the graphviz renderer
                const graphviz = d3.select("#diagram")
                    .graphviz()
                    .zoom(true)
                    .fit(true)
                    .attributer(function(d) {
                        // Add interactivity to nodes
                        if (d.tag === "node") {
                            d.attributes.cursor = "pointer";
                            d.attributes.onclick = `nodeClicked('${d.key}')`;
                        }
                    })
                    .on("end", function() {
                        // This runs after the graph is rendered
                        console.log("Graph rendering complete");
                    });

                // Render the graph
                graphviz.renderDot(dicode);
                const zoomBtn = document.getElementById("resetZoom")
                zoomBtn.style.display = "block";
                zoomBtn.addEventListener("click", function() {
                    graphviz.resetZoom();
                });

                // Function to handle node clicks
                function nodeClicked(nodeId) {
                    console.log("Node clicked:", nodeId);
                    alert(`You clicked on node ${nodeId}`);
                    // You can add more interactive behavior here
                }
            }

            submitButton.addEventListener('click', function() {
                const fname = document.getElementById("fname").value;
                fetch('/create_dfa',
                    {method: 'POST', headers: {
                            'Content-Type': 'application/json'
                        }, body: JSON.stringify({
                            'formula': formulaBox.value,
                            'fname': fname,
                            'visual': drawDiagram.checked
                        })}
                ).then(response => response.json()).then(data => {
                    if (data.success) {
                        create_table(data);
                    } else {
                        alert('Error creating dfa table: ');
                    }
                }).catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while creating DFA table.');
                });
            });

            loadButton.addEventListener('click', function() {
                const fname = document.getElementById("fname").value;
                fetch('/load_dfa', {method: "POST",headers: {
                            'Content-Type': 'application/json'
                        }, body: JSON.stringify({'fname': fname, 'visual':drawDiagram.checked})})
                .then(response => response.json()).then(data => {
                    if (data.success) {
                        create_table(data);
                    } else {
                        alert('Error creating dfa table: ' + data.error);
                    }
                }).catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while creating DFA table.');
                });
            });

            delButton.addEventListener('click', function() {
                const fname = document.getElementById("fname").value;
                fetch('/del_dfa', {method: "POST",headers: {
                            'Content-Type': 'application/json'
                        }, body: JSON.stringify({'fname': fname})})
                .then(response => {
                    if (response.ok) {
                        msgbox.innerHTML = "Deleted file "+fname
                    }
                })
            })

            writeButton.addEventListener('click', function() {
                if (p_formula.innerHTML != "") {
                    formulaBox.value = p_formula.innerText;
                }
            });
            copyButton.addEventListener('click', function() {
                navigator.clipboard.writeText(p_formula.innerText);
            });

            formulaClear.addEventListener('click', function() {
                formulaBox.value = "";
            });
        })
    </script>
</body>